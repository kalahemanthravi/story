<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Story - StoryVerse</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap"
        rel="stylesheet">
</head>

<body>
    <header class="glass">
        <div class="logo">StoryVerse</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="search.html">Search</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div id="reader-container" class="reader-container animate-fade-in">
            <!-- Story content injected here -->
            <div style="text-align: center; padding: 4rem;">Loading story...</div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('reader-container');
            const urlParams = new URLSearchParams(window.location.search);
            const storyId = urlParams.get('id');

            if (!storyId) {
                container.innerHTML = '<div style="text-align: center;">Story not found. <a href="index.html">Go Home</a></div>';
                return;
            }

            let stories = [];
            try {
                const response = await fetch('stories.json');
                stories = await response.json();
            } catch (error) {
                console.error('Error loading stories:', error);
                container.innerHTML = '<p>Failed to load story data.</p>';
                return;
            }

            const story = stories.find(s => s.id === storyId);

            if (!story) {
                container.innerHTML = '<div style="text-align: center;">Story not found. <a href="index.html">Go Home</a></div>';
                return;
            }

            // Update Page Title
            document.title = `${story.title} - StoryVerse`;

            // Render Story
            let html = `
                <header class="reader-header">
                    <img src="${story.cover}" alt="${story.title}" class="reader-cover">
                    <h1 class="reader-title">${story.title}</h1>
                    <div class="reader-meta">
                        By <span style="color: var(--accent-color);">${story.author}</span> &bull; ${story.date} &bull; ${story.language}
                    </div>
                </header>
            `;

            if (story.parts) {
                story.parts.forEach(part => {
                    html += `<section class="story-part">`;
                    if (part.title) {
                        html += `<h2 class="part-title">${part.title}</h2>`;
                    }

                    if (part.content) {
                        part.content.forEach(block => {
                            if (block.type === 'text') {
                                html += `<p class="story-text">${block.value}</p>`;
                            } else if (block.type === 'image') {
                                html += `<img src="${block.value}" class="story-image-insert" loading="lazy" alt="Story illustration">`;
                            }
                        });
                    }
                    html += `</section>`;
                });
            }

            container.innerHTML = html;

            // Handle Progress / Continue Reading
            const progressKey = 'storyProgress';
            let progress = JSON.parse(localStorage.getItem(progressKey)) || {};

            // Restore scroll position
            if (progress[storyId]) {
                const scrollY = progress[storyId].scroll;
                if (scrollY) {
                    window.scrollTo({
                        top: scrollY,
                        behavior: 'smooth'
                    });
                }
            }

            // Save scroll position
            let timeout;
            window.addEventListener('scroll', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    progress = JSON.parse(localStorage.getItem(progressKey)) || {};
                    progress[storyId] = {
                        scroll: window.scrollY,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(progressKey, JSON.stringify(progress));
                }, 500); // Debounce 500ms
            });
        });
    </script>
</body>

</html>